(()=>{"use strict";function t(t,e,n,i,a,r,o){try{var s=t[r](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(i,a)}function e(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function n(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function i(t){for(var i=1;i<arguments.length;i++){var a=null!=arguments[i]?arguments[i]:{};i%2?n(Object(a),!0).forEach(function(n){e(t,n,a[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}var a=["_wpnonce","nonce"];function r(t){return o.apply(this,arguments)}function o(){var e;return e=function*(t){var e,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"auto",o=t;(e="auto"===r?(n=t).startsWith("/wp-json")||!n.startsWith("/wp-admin"):"rest"===r)?o.startsWith("/wp-json")||(o=(window.wpApiSettings&&window.wpApiSettings.root||"/wp-json/").replace(/\/+$/,"/")+o.replace(/^\/+/,"")):o||(o="/wp-admin/admin-ajax.php");var s={method:"POST",credentials:"same-origin",headers:{}},c=i._wpnonce||i.nonce||window.wpApiSettings&&window.wpApiSettings.nonce;if(e){s.headers["Content-Type"]="application/json",c&&(s.headers["X-WP-Nonce"]=c);var{_wpnonce:l,nonce:d}=i,u=function(t,e){if(null==t)return{};var n,i,a=function(t,e){if(null==t)return{};var n={};for(var i in t)if({}.hasOwnProperty.call(t,i)){if(-1!==e.indexOf(i))continue;n[i]=t[i]}return n}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(i=0;i<r.length;i++)n=r[i],-1===e.indexOf(n)&&{}.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}(i,a);s.body=JSON.stringify(u)}else{var f=new URLSearchParams;Object.entries(i).forEach(t=>{var[e,n]=t;null!=n&&f.append(e,String(n))}),c&&!f.has("_wpnonce")&&f.append("_wpnonce",c),s.body=f}var p=yield fetch(o,s),m=(p.headers.get("content-type")||"").includes("application/json");if(!p.ok){var w="HTTP ".concat(p.status);if(m)try{var h=yield p.json();w+=h.message?": ".concat(h.message):""}catch(t){}else{var _=yield p.text();_&&(w+=": ".concat(_.slice(0,200)))}throw new Error(w)}return m?p.json():p.text()},o=function(){var n=this,i=arguments;return new Promise(function(a,r){var o=e.apply(n,i);function s(e){t(o,a,r,s,c,"next",e)}function c(e){t(o,a,r,s,c,"throw",e)}s(void 0)})},o.apply(this,arguments)}const s=window.wp.i18n,c=(window.wp.components,window.wp.date);var l=[{label:"YYYY-MM-DD HH:mm:ss",value:"Y-m-d H:i:s"},{label:"MM/DD/YYYY",value:"m/d/Y"},{label:"DD/MM/YYYY",value:"d/m/Y"},{label:"MMMM D, YYYY",value:"F j, Y"},{label:"HH:mm:ss",value:"H:i:s"},{label:"YYYY.M.D",value:"Y.n.j"},{label:"Day, MMMM D, YYYY",value:"l, F j, Y"},{label:"ddd, MMM D, YYYY",value:"D, M j, Y"},{label:"YYYY年M月D日 (曜日)",value:"Y年n月j日 (l)"}],d=[{key:"str_free",label:(0,s.__)("Free String","block-collections"),value:"%s"},{key:"num_comma",label:(0,s.__)("Numbers (comma separated)","block-collections"),value:{style:"decimal",useGrouping:!0}},{key:"num_no_comma",label:(0,s.__)("Numbers (no commas)","block-collections"),value:{style:"decimal",useGrouping:!1}},{key:"num_amount",label:(0,s.__)("Amount","block-collections"),value:{style:"currency",currency:"JPY"}}],u=(t,e,n,a)=>{var r,o,s=(null===(r=(0,c.getSettings)().l10n)||void 0===r?void 0:r.locale)||"en";if(l.find(t=>t.value===e))return(0,c.format)(e,t,(0,c.getSettings)());var u=null===(o=d.find(t=>t.key===e))||void 0===o?void 0:o.value;if("object"==typeof u)try{var f=parseFloat(t),p=i({},u);return"number"==typeof a&&a>0&&(p.minimumFractionDigits=a,p.maximumFractionDigits=a),new Intl.NumberFormat(s,p).format(f)}catch(e){return console.warn("Number format failed:",e),t}else if("string"==typeof u)return n.replace("%s",t);return t};const f=window.jQuery;function p(t,e){if(!f)return void console.warn("[itmar] jQuery is missing: textEmbed()");const n=null!=t?u(t,e.data("user_format"),e.data("free_format"),e.data("decimal")):null;e.find("h1,h2,h3,h4,h5,h6").each(function(){const t=f(this).find("div");t.length>0&&t.text(n)})}function m(t){if(null==t)return null;if("string"!=typeof t)return t;var e=t.trim();if(""===e)return"";if("true"===e)return!0;if("false"===e)return!1;if("null"===e)return null;if(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]"))try{return JSON.parse(e)}catch(e){return t}var n=Number(e);return Number.isNaN(n)||""===e?t:n}function w(t,e){var n,i=function(t){return t.replace(/-([a-z])/g,(t,e)=>e.toUpperCase())}(e);if(null!=t&&t.dataset&&Object.prototype.hasOwnProperty.call(t.dataset,i))return m(t.dataset[i]);var a=null===(n=t.getAttribute)||void 0===n?void 0:n.call(t,"data-".concat(e));return null!=a?m(a):null}var h=new Map,_=new Set;function v(t,e){if(t&&e){var n="".concat(t.swiper_id,"__").concat(e.swiper_id);if(!_.has(n)){if(_.add(n),e.is_thumbnail)return t.instance.thumbs.swiper=e.instance,t.instance.thumbs.init(),void t.instance.thumbs.update(!0);t.is_thumbnail||(t.instance.on("slideChangeTransitionStart",t=>{e.instance.slideToLoop(t.realIndex,void 0,!1)}),e.instance.on("slideChangeTransitionStart",e=>{t.instance.slideToLoop(e.realIndex,void 0,!1)}))}}}function y(t){var e,n,a,r="string"==typeof t?document.querySelector(t):t;if(!r)return null;var o=w(r,"swiper-id"),s=w(r,"relate-id"),c=!!w(r,"thumb-flg"),l=w(r,"swiper-info"),d=w(r,"parallax-option");if(!l||"object"!=typeof l)throw new Error("data-swiper-info が見つからないか、JSONとして解釈できません。");var u=null!=d?{parallax:!0}:{},f=l.is_autoplay?{freeMode:{enabled:!0,momentum:!1},autoplay:{delay:l.autoplay,stopOnLastSlide:!1,disableOnInteraction:!1}}:{},p={none:{centeredSlides:l.isActiveCenter,direction:l.singleDirection,speed:l.slideSpeed,slidesPerView:l.mobilePerView,spaceBetween:l.mobileBetween,breakpoints:{768:{slidesPerView:l.defaultPerView,spaceBetween:l.defaultBetween}}},slide_single_view:i({direction:l.singleDirection,loopAdditionalSlides:1,speed:l.slideSpeed,allowTouchMove:!1},u),fade_single_view:i({speed:l.slideSpeed,effect:"fade",fadeEffect:{crossFade:!0}},u),coverflow:{centeredSlides:!0,slidesPerView:3,spaceBetween:l.mobileBetween,effect:"coverflow",coverflowEffect:{rotate:50,depth:100,stretch:0,modifier:1,scale:.9,slideShadows:!0},breakpoints:{768:{spaceBetween:l.defaultBetween,coverflowEffect:{stretch:0}}}},coverflow_2:{centeredSlides:!0,slidesPerView:"auto",effect:"coverflow",coverflowEffect:{rotate:0,slideShadows:!1,stretch:100},breakpoints:{768:{coverflowEffect:{stretch:100}}}},cube:{speed:800,effect:"cube",cubeEffect:{slideShadows:!0,shadow:!0,shadowOffset:40,shadowScale:.94},on:{slideChangeTransitionStart:function(){this.el.classList.remove("scale-in"),this.el.classList.add("scale-out")},slideChangeTransitionEnd:function(){this.el.classList.remove("scale-out"),this.el.classList.add("scale-in")}}},flip:{effect:"flip",flipEffect:{limitRotation:!0,slideShadows:!0}},cards:{effect:"cards",cardsEffect:{perSlideOffset:8,perSlideRotate:2,rotate:!0,slideShadows:!0}}},m=i({loop:l.loop},f);c&&(m=i(i({},m),{},{watchSlidesProgress:!0,watchSlidesVisibility:!0,freeMode:!0,slideToClickedSlide:!0})),null!==(e=l.navigation)&&void 0!==e&&e.disp&&(m.navigation={nextEl:".".concat(o,"-next"),prevEl:".".concat(o,"-prev")}),null!==(n=l.pagination)&&void 0!==n&&n.disp&&(m.pagination={el:".".concat(o,"-pagination")}),null!==(a=l.scrollbar)&&void 0!==a&&a.disp&&(m.scrollbar={el:".".concat(o,"-scrollbar")}),l.effect&&p[l.effect]&&(m=i(i({},m),p[l.effect]));var _={instance:new Swiper(r,m),swiper_id:o,relate_id:s,is_thumbnail:c};return o&&h.set(o,_),function(t){for(var e of(t.relate_id&&h.has(t.relate_id)&&v(t,h.get(t.relate_id)),h.values()))e.relate_id===t.swiper_id&&v(e,t)}(_),_}const b=window.jQuery;function g(t,e,n){if(!b)return null;if(!t||!t.jquery)return null;const i=t.find("*").filter(function(){const t=b(this).attr("class");return!!t&&t.split(/\s+/).some(t=>t.startsWith("unit_design_"))});if(!i||0===i.length)return null;let a;return a=e>1.2&&n%2!=0?i.eq(0):e>1.2&&n%2==0?i.eq(1):e<.8&&n%2!=0?i.eq(2):e<.8&&n%2==0?i.eq(3):i.eq(0),a&&a.length?a:i.eq(0)}function k(t,e){let n=t?t[e]:void 0;if(void 0===n)if("image"===e)n=t?.media?.edges?.[0]?.node;else if("images"===e)n=t?.media?.edges;else{const i=t?.variants?.edges?.[0]?.node;i&&e in i&&(n=i[e])}if(void 0!==n)return Array.isArray(n?.edges)?n.edges.map(t=>t.node):n}async function j(t){return await r("/wp-json/itmar-ec-relate/v1/cart/lines",t,"rest")}function S(t){return Array.isArray(t)?t.map(t=>{const e=t.node.id,n=t.node.merchandise.price,i=t.node.merchandise.compareAtPrice,a=t.node.merchandise.quantityAvailable;return{...t.node.merchandise.product,lineId:e,price:n,compareAtPrice:i,quantity:t.node.quantity,quantityAvailable:a}}):[]}const C=window.jQuery;function I(t,e){t.find(".spinner, .particles").each(function(){const t=C(this),n=(t.attr("class")||"").split(/\s+/).filter(t=>"spinner"===t||"particles"===t);t.attr("class",`${n.join(" ")} ${e}`.trim())})}function Y({cart_icon_id:t,wp_user_id:e,rawCartId:n,itemCount:i,estimatedCost:a,checkoutUrl:r,cartContents:o}){if(!C)return;const s=C(`.wp-block-itmar-design-title[data-unique_id="${t}"]`);if(0===s.length)return;if(p(i??0,s),!n)return;const c=s.find(".modal_open_btn").data("modal_id"),l=C(`#${c}`),d=l.find(".wp-block-itmar-cart-block");d.find(".unit_hide").hide(),function(t,e){if(b)if(e&&e.jquery)try{e.children().not(".template_unit").remove();for(const[n,i]of(t||[]).entries()){const t=i?.media?.edges?.[0]?.node,a="VIDEO"===t?.mediaContentType?t?.sources?.[0]:"IMAGE"===t?.mediaContentType?t?.image:null,r=g(e,a?.width&&a?.height?a.width/a.height:1,n+1);if(!r)continue;const o=r.parent().clone(!0);o.find(".hide-wrapper > .wp-block-itmar-design-title,.wp-block-itmar-design-button,.wp-block-itmar-design-text-ctrl,.itmar_ex_block").each(function(){b(this).css("visibility",""),b(this).unwrap()}),e.append(o);const s=o.find('input[name="quantity"]').first();if(s.length){let t=1;const e=s.val();""!==e&&null!=e||s.val(t)}const c=i?.lineId||"",l=i?.variants?.edges?.[0]?.node?.id||"",d=i?.quantity?i.quantity:1;o.find('[type="submit"]').attr({"data-line-id":c,"data-variant-id":l,"data-quantity":d}),o.find("[class*='sp_field_']").each(function(){const t=b(this),e=(t.attr("class")||"").split(/\s+/).find(t=>t.startsWith("sp_field_"));if(!e)return;const a=e.replace("sp_field_",""),r=k(i,a);if(void 0===r)return;const o=t.attr("class")||"";if(o.includes("wp-block-itmar-design-title")){const e=t.find("h1,h2,h3,h4,h5,h6").first().find("div").first();if(e.length){const n=null==r?"":"object"==typeof r&&"price"===a&&r.amount||"object"==typeof r&&"compareAtPrice"===a&&r.amount?r.amount:r,i=null!=r?u(n,t.data("user_format"),t.data("free_format"),t.data("decimal")):"";e.text(i)}return}if(o.includes("wp-block-itmar-design-text-ctrl")){const e=t.find("input").first();return void(e.length&&e.val(r))}if(o.includes("wp-block-image")){const e=t.find("img").first();if(!e.length)return;if("IMAGE"===r?.mediaContentType)return e.attr("src",r.image?.url||""),void e.attr("alt",r.image?.altText||"");if("VIDEO"===r?.mediaContentType){const t=b("<video>",{src:r.sources?.[0]?.url||"",controls:!0,autoplay:!1,muted:!0,loop:!1});return t.attr("class",e.attr("class")||""),t.attr("style",e.attr("style")||""),b.each(e.data(),function(e,n){t.attr("data-"+e,n)}),t.css({width:"100%",height:"auto",display:"block",objectFit:"cover"}),void e.replaceWith(t)}return"featuredImage"===a?(e.attr("src",r?.url||""),void e.attr("alt",r?.altText||"")):void 0}if(t.is("p")){const e="object"==typeof r&&null!=r?.amount?r.amount:r;return void t.text(e)}if(o.includes("wp-block-itmar-slide-mv")){const e=`slide-${n}`,i=t.find(".swiper");if(!i.length)return;i.removeData("swiper-id"),i.attr("data-swiper-id",e);const a={prev:"swiper-button-prev",next:"swiper-button-next",pagination:"swiper-pagination",scrollbar:"swiper-scrollbar"};Object.entries(a).forEach(([t,n])=>{i.parent().find(`.${n}`).each(function(){const i=(b(this).attr("class")||"").split(/\s+/).filter(t=>t===n);i.push(`${e}-${t}`),b(this).attr("class",i.join(" "))})});const o=i.find(".swiper-wrapper").find(".swiper-slide").first();i.empty();const s=b('<div class="swiper-wrapper"></div>');return(r||[]).forEach(t=>{const e=o.clone(!0);Array.from(e[0].attributes).forEach(t=>{"class"!==t.name&&e.removeAttr(t.name)});const n=e.find("img").first(),i=t?.node||t;n.length&&"IMAGE"===i?.mediaContentType&&(n.attr("src",i.image?.url||""),n.attr("alt",i.image?.altText||""),s.append(e))}),i.append(s),void y(i[0])}})}}catch(t){console.error("replaceContent failed:",t)}else console.warn("[replaceContent] target_block must be jQuery object");else console.warn("[replaceContent] jQuery is missing")}(o,d),l.find('button[data-key="go_checkout"]').attr("data-selected_page",r||"");const f=l.find('div[data-unique_id="subtotalAmount"]'),m=l.find('div[data-unique_id="totalTaxAmount"]'),w=l.find('div[data-unique_id="totalAmount"]');null!=a?.subtotalAmount?.amount&&p(a.subtotalAmount.amount,f),p(a?.totalTaxAmount?.amount?a.totalTaxAmount.amount:0,m),null!=a?.totalAmount?.amount&&p(a.totalAmount.amount,w)}async function O({rawCartId:t,wp_user_id:e,accessToken:n,cart_icon_id:i}){if(!t)return void Y({cart_icon_id:i,wp_user_id:e,rawCartId:"",itemCount:0,estimatedCost:null,checkoutUrl:"",cartContents:[]});const a=decodeURIComponent(t);console.log(a);const o=await j({cartId:a,wp_user_id:e,mode:"bind_cart",nonce:itmar_option.nonce});if(o?.success){const s=S(o.cartContents);if(Y({cart_icon_id:i,wp_user_id:e,rawCartId:t,itemCount:o.itemCount,estimatedCost:o.estimatedCost,checkoutUrl:o.checkoutUrl,cartContents:s}),n&&!o.buyerId)try{await async function({cartId:t,accessToken:e}){const n={cart_id:t,customer_token:e,nonce:itmar_option.nonce};return await r("/wp-json/itmar-ec-relate/v1/cart/bind",n,"rest")}({cartId:a,accessToken:n}),document.cookie="shopify_cart_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}catch(t){console.warn("[itmar cart] bindCartToCustomer failed:",t)}}else console.warn("[itmar cart] no cart info")}async function A(t){const e=jQuery(t),n=e.data("cart_icon_id")||null,i=e.data("cart_id")||null;let a=localStorage.getItem("shopify_client_access_token")||null;itmar_option.isLoggedIn||localStorage.removeItem("shopify_client_access_token");let o="",s="";if(a)try{const t=await async function(t){if(!window.itmar_option?.isLoggedIn)return null;if(!t)return null;const e=localStorage.getItem("shopify_shop_id"),n=localStorage.getItem("shopify_client_id");if(!e||!n)return null;const i=window.itmar_option?.ajaxUrl||window.ajaxurl;if(!i)return null;const a={action:"validate-customer",shop_id:e,client_id:n,customerAccessToken:t,_wpnonce:window.itmar_option?.nonce};return await r(i,a,"ajax")||null}(a);if(console.log(t),t?.success&&(t.data?.access_token&&(a=t.data.access_token,localStorage.setItem("shopify_client_access_token",a)),t.data?.wp_user_id&&(o=t.data.wp_user_id),t.data?.cart_id&&(s=t.data.cart_id),t.data?.reload))return window.location.reload(),null}catch(t){console.warn("[cart] validate-customer failed:",t)}let c="";return s?(c=s,localStorage.setItem("shopify_cart_id",c)):c=function(){const t=document.cookie.match(new RegExp("(^| )shopify_cart_id=([^;]+)"));return t?t[2]:null}()||"",{cartRoot:t,cartRoot:t,modal_id:i,cart_icon_id:n,rawCartId:c,wp_user_id:o,accessToken:a}}!function(){if(!C)return;const t=Array.from(document.querySelectorAll(".wp-block-itmar-cart-block"));if(0===t.length)return;const e=new WeakMap;(async()=>{for(const n of t){const t=await A(n);e.set(n,t),t.cart_icon_id&&await O(t)}})(),C(document).on("submit","form",async function(n){const i=n.originalEvent?.submitter;if(!i)return;const a=C(i),r=a.data("key");if(!r)return;if(!["into_cart","trush_out","calc_again","soon_buy","go_shopify"].includes(r))return;const o=C(".wp-block-itmar-cart-block").data("cart_id");if(0===a.closest(`#${o}, .wp-block-itmar-product-block`).length)return;n.preventDefault();const s=t[0],c=e.get(s)||await A(s);e.set(s,c),await async function(t,e,n){const i=C(t),a=i.data("key"),r=n?.cart_icon_id?C(`[data-unique_id="${n.cart_icon_id}"]`):C();r.length&&function(t){t.find(".particles").each(function(){C(this).one("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",function(e){const n=e.originalEvent?e.originalEvent.animationName:e.animationName;n&&"burst"!==n||I(t,"hold")})})}(r);let o=n.rawCartId?decodeURIComponent(n.rawCartId):"";"soon_buy"===a?o="":r.length&&"go_shopify"!=a&&I(r,"exec");const s=e.find('[class*="unit_design_"]').filter(function(){return 0===C(this).closest(".template_unit").length}).map(function(){const t=C(this);return{id:t.find('button[data-key="trush_out"]').data("line-id"),quantity:parseInt(t.find(".sp_field_quantity input").val(),10)||0}}).get(),c=i.data("lineId")||i.data("line-id")||"",l=i.data("variantId")||i.data("variant-id")||"";let d=Number(i.data("quantity"))||1;const u=i.closest('[class*="unit_design_"]').find('.sp_field_quantity input, input[name="quantity"]');if(u.length){const t=parseInt(u.val(),10);Number.isNaN(t)||(d=t)}const f={form_data:JSON.stringify(s),lineId:c,cartId:o,productId:l,quantity:d,mode:a,wp_user_id:n.wp_user_id||"",nonce:itmar_option.nonce};try{const t=await j(f);if("soon_buy"===a||"go_shopify"===a)return void(t?.checkoutUrl?window.open(t.checkoutUrl,"_blank"):(alert("チェックアウトURLの取得に失敗しました。"),console.error("Unexpected response:",t)));if("into_cart"===a||"trush_out"===a||"calc_again"===a)if(t?.success){n.rawCartId=t.cartId||n.rawCartId;const e=S(t.cartContents);Y({cart_icon_id:n.cart_icon_id,wp_user_id:n.wp_user_id,rawCartId:n.rawCartId,itemCount:t.itemCount,estimatedCost:t.estimatedCost,checkoutUrl:t.checkoutUrl,cartContents:e})}else alert("カートの作成に失敗しました")}catch(t){alert("サーバー通信エラーが発生しました。"),console.error("サーバー通信エラー:",t)}finally{"soon_buy"!==a&&r.length&&I(r,"done")}}(i,C(this),c)})}()})();