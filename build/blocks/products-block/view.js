(()=>{"use strict";var e={n:t=>{var i=t&&t.__esModule?()=>t.default:()=>t;return e.d(i,{a:i}),i},d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.apiFetch;var i=e.n(t);function n(e,t,i,n,r,o,a){try{var s=e[o](a),l=s.value}catch(e){return void i(e)}s.done?t(l):Promise.resolve(l).then(n,r)}function r(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){r(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var s=["_wpnonce","nonce"];function l(e){return c.apply(this,arguments)}function c(){var e;return e=function*(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"auto",o=e;(t="auto"===r?(i=e).startsWith("/wp-json")||!i.startsWith("/wp-admin"):"rest"===r)?o.startsWith("/wp-json")||(o=(window.wpApiSettings&&window.wpApiSettings.root||"/wp-json/").replace(/\/+$/,"/")+o.replace(/^\/+/,"")):o||(o="/wp-admin/admin-ajax.php");var a={method:"POST",credentials:"same-origin",headers:{}},l=n._wpnonce||n.nonce||window.wpApiSettings&&window.wpApiSettings.nonce;if(t){a.headers["Content-Type"]="application/json",l&&(a.headers["X-WP-Nonce"]=l);var{_wpnonce:c,nonce:d}=n,u=function(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;i[n]=e[n]}return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],-1===t.indexOf(i)&&{}.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}(n,s);a.body=JSON.stringify(u)}else{var p=new URLSearchParams;Object.entries(n).forEach(e=>{var[t,i]=e;null!=i&&p.append(t,String(i))}),l&&!p.has("_wpnonce")&&p.append("_wpnonce",l),a.body=p}var f=yield fetch(o,a),m=(f.headers.get("content-type")||"").includes("application/json");if(!f.ok){var h="HTTP ".concat(f.status);if(m)try{var w=yield f.json();h+=w.message?": ".concat(w.message):""}catch(e){}else{var g=yield f.text();g&&(h+=": ".concat(g.slice(0,200)))}throw new Error(h)}return m?f.json():f.text()},c=function(){var t=this,i=arguments;return new Promise(function(r,o){var a=e.apply(t,i);function s(e){n(a,r,o,s,l,"next",e)}function l(e){n(a,r,o,s,l,"throw",e)}s(void 0)})},c.apply(this,arguments)}var d="__itmar_pickup_store__",u=(window[d]||(window[d]={contexts:new Map}),window[d]).contexts;function p(e){return e?(u.has(e)||u.set(e,function(e){return{id:e,pickupEl:null,dataset:{},state:{page:0,searchKeyWord:"",periodDisp:"",periodQueryObj:{},termParamObj:null,termQueryObj:[],posts:[],rawPosts:null,targetIndex:-1,total:0},listeners:new Set,cache:{taxonomies:null},inflight:{abort:null}}}(e)),u.get(e)):null}const f=window.wp.i18n,m=(window.wp.components,window.wp.date);var h=[{label:"YYYY-MM-DD HH:mm:ss",value:"Y-m-d H:i:s"},{label:"MM/DD/YYYY",value:"m/d/Y"},{label:"DD/MM/YYYY",value:"d/m/Y"},{label:"MMMM D, YYYY",value:"F j, Y"},{label:"HH:mm:ss",value:"H:i:s"},{label:"YYYY.M.D",value:"Y.n.j"},{label:"Day, MMMM D, YYYY",value:"l, F j, Y"},{label:"ddd, MMM D, YYYY",value:"D, M j, Y"},{label:"YYYY年M月D日 (曜日)",value:"Y年n月j日 (l)"}],w=[{key:"str_free",label:(0,f.__)("Free String","block-collections"),value:"%s"},{key:"num_comma",label:(0,f.__)("Numbers (comma separated)","block-collections"),value:{style:"decimal",useGrouping:!0}},{key:"num_no_comma",label:(0,f.__)("Numbers (no commas)","block-collections"),value:{style:"decimal",useGrouping:!1}},{key:"num_amount",label:(0,f.__)("Amount","block-collections"),value:{style:"currency",currency:"JPY"}}],g=(e,t,i,n)=>{var r,o,s=(null===(r=(0,m.getSettings)().l10n)||void 0===r?void 0:r.locale)||"en";if(h.find(e=>e.value===t))return(0,m.format)(t,e,(0,m.getSettings)());var l=null===(o=w.find(e=>e.key===t))||void 0===o?void 0:o.value;if("object"==typeof l)try{var c=parseFloat(e),d=a({},l);return"number"==typeof n&&n>0&&(d.minimumFractionDigits=n,d.maximumFractionDigits=n),new Intl.NumberFormat(s,d).format(c)}catch(t){return console.warn("Number format failed:",t),e}else if("string"==typeof l)return i.replace("%s",e);return e};function v(e){if(null==e)return null;if("string"!=typeof e)return e;var t=e.trim();if(""===t)return"";if("true"===t)return!0;if("false"===t)return!1;if("null"===t)return null;if(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return JSON.parse(t)}catch(t){return e}var i=Number(t);return Number.isNaN(i)||""===t?e:i}function _(e,t){var i,n=function(e){return e.replace(/-([a-z])/g,(e,t)=>t.toUpperCase())}(t);if(null!=e&&e.dataset&&Object.prototype.hasOwnProperty.call(e.dataset,n))return v(e.dataset[n]);var r=null===(i=e.getAttribute)||void 0===i?void 0:i.call(e,"data-".concat(t));return null!=r?v(r):null}var y=new Map,b=new Set;function S(e,t){if(e&&t){var i="".concat(e.swiper_id,"__").concat(t.swiper_id);if(!b.has(i)){if(b.add(i),t.is_thumbnail)return e.instance.thumbs.swiper=t.instance,e.instance.thumbs.init(),void e.instance.thumbs.update(!0);e.is_thumbnail||(e.instance.on("slideChangeTransitionStart",e=>{t.instance.slideToLoop(e.realIndex,void 0,!1)}),t.instance.on("slideChangeTransitionStart",t=>{e.instance.slideToLoop(t.realIndex,void 0,!1)}))}}}function j(e){var t,i,n,r="string"==typeof e?document.querySelector(e):e;if(!r)return null;var o=_(r,"swiper-id"),s=_(r,"relate-id"),l=!!_(r,"thumb-flg"),c=_(r,"swiper-info"),d=_(r,"parallax-option");if(!c||"object"!=typeof c)throw new Error("data-swiper-info が見つからないか、JSONとして解釈できません。");var u=null!=d?{parallax:!0}:{},p=c.is_autoplay?{freeMode:{enabled:!0,momentum:!1},autoplay:{delay:c.autoplay,stopOnLastSlide:!1,disableOnInteraction:!1}}:{},f={none:{centeredSlides:c.isActiveCenter,direction:c.singleDirection,speed:c.slideSpeed,slidesPerView:c.mobilePerView,spaceBetween:c.mobileBetween,breakpoints:{768:{slidesPerView:c.defaultPerView,spaceBetween:c.defaultBetween}}},slide_single_view:a({direction:c.singleDirection,loopAdditionalSlides:1,speed:c.slideSpeed,allowTouchMove:!1},u),fade_single_view:a({speed:c.slideSpeed,effect:"fade",fadeEffect:{crossFade:!0}},u),coverflow:{centeredSlides:!0,slidesPerView:3,spaceBetween:c.mobileBetween,effect:"coverflow",coverflowEffect:{rotate:50,depth:100,stretch:0,modifier:1,scale:.9,slideShadows:!0},breakpoints:{768:{spaceBetween:c.defaultBetween,coverflowEffect:{stretch:0}}}},coverflow_2:{centeredSlides:!0,slidesPerView:"auto",effect:"coverflow",coverflowEffect:{rotate:0,slideShadows:!1,stretch:100},breakpoints:{768:{coverflowEffect:{stretch:100}}}},cube:{speed:800,effect:"cube",cubeEffect:{slideShadows:!0,shadow:!0,shadowOffset:40,shadowScale:.94},on:{slideChangeTransitionStart:function(){this.el.classList.remove("scale-in"),this.el.classList.add("scale-out")},slideChangeTransitionEnd:function(){this.el.classList.remove("scale-out"),this.el.classList.add("scale-in")}}},flip:{effect:"flip",flipEffect:{limitRotation:!0,slideShadows:!0}},cards:{effect:"cards",cardsEffect:{perSlideOffset:8,perSlideRotate:2,rotate:!0,slideShadows:!0}}},m=a({loop:c.loop},p);l&&(m=a(a({},m),{},{watchSlidesProgress:!0,watchSlidesVisibility:!0,freeMode:!0,slideToClickedSlide:!0})),null!==(t=c.navigation)&&void 0!==t&&t.disp&&(m.navigation={nextEl:".".concat(o,"-next"),prevEl:".".concat(o,"-prev")}),null!==(i=c.pagination)&&void 0!==i&&i.disp&&(m.pagination={el:".".concat(o,"-pagination")}),null!==(n=c.scrollbar)&&void 0!==n&&n.disp&&(m.scrollbar={el:".".concat(o,"-scrollbar")}),c.effect&&f[c.effect]&&(m=a(a({},m),f[c.effect]));var h={instance:new Swiper(r,m),swiper_id:o,relate_id:s,is_thumbnail:l};return o&&y.set(o,h),function(e){for(var t of(e.relate_id&&y.has(e.relate_id)&&S(e,y.get(e.relate_id)),y.values()))t.relate_id===e.swiper_id&&S(t,e)}(h),h}const k=window.jQuery;function O(e,t,i){if(!k)return null;if(!e||!e.jquery)return null;const n=e.find("*").filter(function(){const e=k(this).attr("class");return!!e&&e.split(/\s+/).some(e=>e.startsWith("unit_design_"))});if(!n||0===n.length)return null;let r;return r=t>1.2&&i%2!=0?n.eq(0):t>1.2&&i%2==0?n.eq(1):t<.8&&i%2!=0?n.eq(2):t<.8&&i%2==0?n.eq(3):n.eq(0),r&&r.length?r:n.eq(0)}function Y(e,t){let i=e?e[t]:void 0;if(void 0===i)if("image"===t)i=e?.media?.edges?.[0]?.node;else if("images"===t)i=e?.media?.edges;else{const n=e?.variants?.edges?.[0]?.node;n&&t in n&&(i=n[t])}if(void 0!==i)return Array.isArray(i?.edges)?i.edges.map(e=>e.node):i}function I(e,t){if(k)if(t&&t.jquery)try{t.children().not(".template_unit").remove();for(const[i,n]of(e||[]).entries()){const e=n?.media?.edges?.[0]?.node,r="VIDEO"===e?.mediaContentType?e?.sources?.[0]:"IMAGE"===e?.mediaContentType?e?.image:null,o=O(t,r?.width&&r?.height?r.width/r.height:1,i+1);if(!o)continue;const a=o.parent().clone(!0);a.find(".hide-wrapper > .wp-block-itmar-design-title,.wp-block-itmar-design-button,.wp-block-itmar-design-text-ctrl,.itmar_ex_block").each(function(){k(this).css("visibility",""),k(this).unwrap()}),t.append(a);const s=a.find('input[name="quantity"]').first();if(s.length){let e=1;const t=s.val();""!==t&&null!=t||s.val(e)}const l=n?.lineId||"",c=n?.variants?.edges?.[0]?.node?.id||"",d=n?.quantity?n.quantity:1;a.find('[type="submit"]').attr({"data-line-id":l,"data-variant-id":c,"data-quantity":d}),a.find("[class*='sp_field_']").each(function(){const e=k(this),t=(e.attr("class")||"").split(/\s+/).find(e=>e.startsWith("sp_field_"));if(!t)return;const r=t.replace("sp_field_",""),o=Y(n,r);if(void 0===o)return;const a=e.attr("class")||"";if(a.includes("wp-block-itmar-design-title")){const t=e.find("h1,h2,h3,h4,h5,h6").first().find("div").first();if(t.length){const i=null==o?"":"object"==typeof o&&"price"===r&&o.amount||"object"==typeof o&&"compareAtPrice"===r&&o.amount?o.amount:o,n=null!=o?g(i,e.data("user_format"),e.data("free_format"),e.data("decimal")):"";t.text(n)}return}if(a.includes("wp-block-itmar-design-text-ctrl")){const t=e.find("input").first();return void(t.length&&t.val(o))}if(a.includes("wp-block-image")){const t=e.find("img").first();if(!t.length)return;if("IMAGE"===o?.mediaContentType)return t.attr("src",o.image?.url||""),void t.attr("alt",o.image?.altText||"");if("VIDEO"===o?.mediaContentType){const e=k("<video>",{src:o.sources?.[0]?.url||"",controls:!0,autoplay:!1,muted:!0,loop:!1});return e.attr("class",t.attr("class")||""),e.attr("style",t.attr("style")||""),k.each(t.data(),function(t,i){e.attr("data-"+t,i)}),e.css({width:"100%",height:"auto",display:"block",objectFit:"cover"}),void t.replaceWith(e)}return"featuredImage"===r?(t.attr("src",o?.url||""),void t.attr("alt",o?.altText||"")):void 0}if(e.is("p")){const t="object"==typeof o&&null!=o?.amount?o.amount:o;return void e.text(t)}if(a.includes("wp-block-itmar-slide-mv")){const t=`slide-${i}`,n=e.find(".swiper");if(!n.length)return;n.removeData("swiper-id"),n.attr("data-swiper-id",t);const r={prev:"swiper-button-prev",next:"swiper-button-next",pagination:"swiper-pagination",scrollbar:"swiper-scrollbar"};Object.entries(r).forEach(([e,i])=>{n.parent().find(`.${i}`).each(function(){const n=(k(this).attr("class")||"").split(/\s+/).filter(e=>e===i);n.push(`${t}-${e}`),k(this).attr("class",n.join(" "))})});const a=n.find(".swiper-wrapper").find(".swiper-slide").first();n.empty();const s=k('<div class="swiper-wrapper"></div>');return(o||[]).forEach(e=>{const t=a.clone(!0);Array.from(t[0].attributes).forEach(e=>{"class"!==e.name&&t.removeAttr(e.name)});const i=t.find("img").first(),n=e?.node||e;i.length&&"IMAGE"===n?.mediaContentType&&(i.attr("src",n.image?.url||""),i.attr("alt",n.image?.altText||""),s.append(t))}),n.append(s),void j(n[0])}})}}catch(e){console.error("replaceContent failed:",e)}else console.warn("[replaceContent] target_block must be jQuery object");else console.warn("[replaceContent] jQuery is missing")}!async function(){if(await async function(){const e=new URLSearchParams(window.location.search);if(e.get("shopify_logout_completed")){const e=localStorage.getItem("shopify_logout_redirect_to")||"/";if(e){localStorage.removeItem("shopify_shop_id"),localStorage.removeItem("shopify_logout_redirect_to"),localStorage.removeItem("shopify_client_access_token"),localStorage.removeItem("shopify_client_id_token"),document.cookie="shopify_cart_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";try{const t=await l("/wp-json/itmar-ec-relate/v1/wp-logout-redirect",{redirect_url:e,_wpnonce:itmar_option.nonce},"rest");if(t.success&&t.logout_url)return window.location.href=t.logout_url,!0;console.error("ログアウトURLの取得に失敗しました")}catch(e){console.error("ログアウト処理でエラー:",e)}}}const t=e.get("code"),i=e.get("state");if(!t||!i)return!1;const n=localStorage.getItem("shopify_shop_id"),r=localStorage.getItem("shopify_client_id"),o=localStorage.getItem("shopify_user_mail"),a=localStorage.getItem("shopify_redirect_uri"),s=localStorage.getItem("shopify_state"),c=localStorage.getItem("shopify_code_verifier");if(i!==s||!c)return console.error("認証コードまたはステートが無効です。"),!0;try{const e="/wp-json/itmar-ec-relate/v1/customer/token-exchange",s={code:t,code_verifier:c,redirect_uri:a,shop_id:n,client_id:r,user_mail:o,nonce:itmar_option.nonce},d=await l(e,s,"rest");if(!d.success)return alert("トークンの取得に失敗しました。"),!0;localStorage.setItem("shopify_client_access_token",d.token.access_token),localStorage.setItem("shopify_client_id_token",d.token.id_token),localStorage.setItem("shopify_access_expires_at",Math.floor(d.expires_at/1e3));const u=JSON.parse(atob(i)).return_url||"/";return u?(localStorage.removeItem("shopify_code_verifier"),localStorage.removeItem("shopify_state"),localStorage.removeItem("shopify_nonce"),window.location.href=u,!0):(console.log("リダイレクト先が指定されていません。"),!0)}catch(e){return console.error("エラーが発生しました:",e),!0}}())return;const e=window.jQuery;e?e(function(){!function(e){itmar_option.isLoggedIn||localStorage.removeItem("shopify_client_access_token");const t=localStorage.getItem("shopify_shop_id"),n=localStorage.getItem("shopify_client_id"),r=localStorage.getItem("shopify_client_access_token");console.log("customer token: ",r);const o=e(".wp-block-itmar-product-block");if(o.length<1)return;const s=function(e){var t,i=null==e||null===(t=e.dataset)||void 0===t?void 0:t.pickup_id;if(!i)return null;var n=p(i);return n.pickupEl=e,n.dataset=a({},e.dataset),n}(o[0]);o.find(".unit_hide .wp-block-itmar-design-title,.wp-block-itmar-design-button,.wp-block-itmar-design-text-ctrl,.itmar_ex_block").each(function(){e(this).wrap('<div class="hide-wrapper"></div>'),e(this).css("visibility","hidden")});let c="",d="",u="";(async()=>{try{if(t&&r){const e=window.itmar_option?.ajaxUrl||window.ajaxurl;if(!e)throw new Error("Ajax URL is missing");const i={action:"validate-customer",shop_id:t,client_id:n,customerAccessToken:r,_wpnonce:itmar_option.nonce},o=await l(e,i,"ajax");if(o.success&&o.data?.reload)return void window.location.reload();if(o.success){d=o.data.wp_user_mail;const e=o.data.valid?o.data.customer?.emailAddress?.emailAddress:"";o.data.access_token&&localStorage.setItem("shopify_client_access_token",o.data.access_token),d===e&&(c=o.data.wp_user_id,u=o.data.cart_id,console.log(c))}}const e=o.data("selected_fields");if(!e)return;const f=e.map(e=>e.key),m=o.data("number_of_items");let h=null,w=[];!function(e,t){var i=p(e);i&&(i.listeners.add(t),t(i))}(s.id,async e=>{o.children().not(".template_unit").remove(),o.find(".unit_hide").show();const t=e.state,n=t.page??0,r=t.searchKeyWord,s=t.termQueryObj.map(e=>e.term.id),l=t.cursorByPage||{0:null},c=Object.keys(l).map(e=>parseInt(e,10)).filter(e=>Number.isFinite(e)&&e<=n),d=c.length?Math.max(...c):0,u=l[d]??null,g=JSON.stringify({pageNum:n,itemNum:m,anchorPage:d,anchorCursor:u,fields:f,searchKeyWord:r,categoryIds:s});if(g===h)return;h=g,w=await i()({path:"/itmar-ec-relate/v1/get-product",method:"POST",data:{fields:f,itemNum:m,page:n,anchorPage:d,anchorCursor:u,searchKeyWord:r,categoryIds:s,includeCount:!0}});const v=w?.pageInfo?.endCursor??null;if(v){const t={...l,[n+1]:v};!function(e,t){var i=p(e);i&&(i.state=a(a({},i.state),t),i.listeners.forEach(e=>e(i)))}(e.id,{total:w.count.count,cursorByPage:t})}I(w.products,o),o.find(".unit_hide").hide()})}catch(e){alert("顧客関連通信エラーが発生しました。"),console.error(e.message)}})()}(e)}):console.warn("[itmar] jQuery is missing. products-block cannot initialize.")}()})();